#! /usr/bin/env python3
# ! -*- coding:utf-8 -*-

import requests
import base64
import json
import pymysql as mdb
import time
import matplotlib.dates as mdate
import datetime

json={
    "data": {
        "SAMY10171201RBST0101036": {
            "C1": "noData",
            "C13": 25.5,
            "C14": 0,
            "C18": 38.5,
            "C19": 0.005,
            "C20": 0,
            "C3": 23.5,
            "C4": 24,
            "T0": "0",
            "T1": "2018-04-30 11:58",
            "T2": "2018-04-30 11:58",
            "T3": "2018-04-30 11:58"
        },
        "SAMY10171201RBST0101072": {
            "C1": 17.5,
            "C13": 23,
            "C14": 0,
            "C18": 25,
            "C19": 0,
            "C20": "noData",
            "C3": 15,
            "C4": 17.5,
            "T0": "0",
            "T1": "2018-03-23 13:19",
            "T2": "2018-03-23 13:24",
            "T3": "2018-03-23 13:23"
        },
        "SAMY10171201RBST0101114": {
            "C1": 18.5,
            "C13": 21,
            "C14": 0,
            "C18": 29.5,
            "C19": 0.005,
            "C20": 0,
            "C3": 13.5,
            "C4": 14.5,
            "T0": "0",
            "T1": "2018-03-24 15:28",
            "T2": "2018-03-24 17:50",
            "T3": "2018-03-24 17:49"
        },
        "SAMY10171201RBST0101142": {
            "C1": "noData",
            "C13": 9.5,
            "C14": 0,
            "C18": 25.5,
            "C19": 0.88,
            "C20": 0,
            "C3": 30.5,
            "C4": 30,
            "T0": "0",
            "T1": "2018-04-07 10:26",
            "T2": "2018-04-07 11:14",
            "T3": "2018-04-07 11:12"
        },
        "SAMY10171201RBST0101197": {
            "C1": 13.5,
            "C13": 2,
            "C14": 0,
            "C18": 25,
            "C19": 0.88,
            "C20": 0,
            "C3": 14.5,
            "C4": 14,
            "T0": "0",
            "T1": "2018-03-16 05:09",
            "T2": "2018-03-16 07:52",
            "T3": "2018-03-16 07:52"
        },
        "SAMY10171201RBST0101260": {
            "C1": 20,
            "C13": 15.5,
            "C14": 0,
            "C18": 25,
            "C19": 1,
            "C20": 1,
            "C3": 25,
            "C4": 25.5,
            "T0": "0",
            "T1": "2018-04-08 11:40",
            "T2": "2018-04-08 11:55",
            "T3": "2018-04-08 11:55"
        },
        "SAMY10171201RBST0101267": {
            "C1": 18,
            "C13": 23,
            "C14": 0,
            "C18": 25,
            "C19": 0.88,
            "C20": 0,
            "C3": 13.5,
            "C4": 15,
            "T0": "0",
            "T1": "2018-03-24 11:02",
            "T2": "2018-03-24 12:05",
            "T3": "2018-03-24 12:04"
        },
        "SAMY10171201RBST0101318": {
            "C1": "noData",
            "C13": 2.5,
            "C14": 0,
            "C18": 55,
            "C19": 0.96,
            "C20": 0.1,
            "C3": 18,
            "C4": 19,
            "T0": "0",
            "T1": "2018-04-05 02:03",
            "T2": "2018-04-05 02:04",
            "T3": "2018-04-05 02:03"
        },
        "SAMY10171201RBST0101319": {
            "C1": 16,
            "C13": 6,
            "C14": 0,
            "C18": 30,
            "C19": 1,
            "C20": 1,
            "C3": 28,
            "C4": 30,
            "T0": "0",
            "T1": "2018-04-06 06:42",
            "T2": "2018-04-06 06:44",
            "T3": "2018-04-06 06:42"
        },
        "SAMY10171201RBST0101325": {
            "C1": 18,
            "C13": 5.5,
            "C14": 0,
            "C18": 35.5,
            "C19": 1,
            "C20": 0,
            "C3": 31.5,
            "C4": 32,
            "T0": "0",
            "T1": "2018-03-18 10:38",
            "T2": "2018-03-18 10:40",
            "T3": "2018-03-18 10:38"
        },
        "SAMY10171201RBST0101326": {
            "C1": "noData",
            "C13": 15.5,
            "C14": 0,
            "C18": 36,
            "C19": 0.88,
            "C20": 0,
            "C3": 15.5,
            "C4": 15.5,
            "T0": "0",
            "T1": "2018-03-31 09:09",
            "T2": "2018-03-31 09:10",
            "T3": "2018-03-31 09:09"
        },
        "SAMY10171201RBST0101335": {
            "C1": 19,
            "C13": 16.5,
            "C14": 0,
            "C18": 34,
            "C19": 0.96,
            "C20": 0.1,
            "C3": 16.5,
            "C4": 16.5,
            "T0": "0",
            "T1": "2018-03-27 08:03",
            "T2": "2018-03-27 09:04",
            "T3": "2018-03-27 09:03"
        },
        "SAMY10171201RBST0101337": {
            "C1": "noData",
            "C13": 21.5,
            "C14": 0,
            "C18": 30,
            "C19": 0.88,
            "C20": 0,
            "C3": 20,
            "C4": 20,
            "T0": "0",
            "T1": "2018-03-24 14:11",
            "T2": "2018-03-24 17:42",
            "T3": "2018-03-24 17:40"
        },
        "SAMY10171201RBST0101424": {
            "C1": "noData",
            "C13": 27.5,
            "C14": 0,
            "C18": 47.5,
            "C19": 1,
            "C20": 0,
            "C3": 33,
            "C4": 32,
            "T0": "0",
            "T1": "2018-05-13 17:43",
            "T2": "2018-05-13 17:53",
            "T3": "2018-05-13 17:51"
        },
        "SAMY10171201RBST0101429": {
            "C1": "noData",
            "C13": 5,
            "C14": 0,
            "C18": 40.5,
            "C19": 1,
            "C20": 1,
            "C3": 38,
            "C4": 40,
            "T0": "0",
            "T1": "2018-02-12 13:13",
            "T2": "2018-02-12 13:43",
            "T3": "2018-02-12 13:42"
        },
        "SAMY10171201RBST0101431": {
            "C1": "noData",
            "C13": 7,
            "C14": 0,
            "C18": 55,
            "C19": 1,
            "C20": 0,
            "C3": 0,
            "C4": 2,
            "T0": "0",
            "T1": "2018-01-20 13:55",
            "T2": "2018-01-20 13:57",
            "T3": "2018-01-20 13:56"
        },
        "SAMY10171201RBST0101432": {
            "C1": "noData",
            "C13": 3.5,
            "C14": 0,
            "C18": 45,
            "C19": 1,
            "C20": 0,
            "C3": 3,
            "C4": 5,
            "T0": "0",
            "T1": "2018-01-20 13:16",
            "T2": "2018-01-20 13:18",
            "T3": "2018-01-20 13:16"
        },
        "SAMY10171201RBST0101453": {
            "C1": 16,
            "C13": 18,
            "C14": 0,
            "C18": 27,
            "C19": 0.64,
            "C20": 0.35,
            "C3": 17.5,
            "C4": 17.5,
            "T0": "0",
            "T1": "2018-03-27 10:20",
            "T2": "2018-03-27 10:24",
            "T3": "2018-03-27 10:22"
        },
        "SAMY10171201RBST0101485": {
            "C1": "noData",
            "C13": 11,
            "C14": 0,
            "C18": 30,
            "C19": 1,
            "C20": 1,
            "C3": 30.5,
            "C4": 32,
            "T0": "0",
            "T1": "2018-04-10 02:00",
            "T2": "2018-04-10 07:00",
            "T3": "2018-04-10 06:58"
        },
        "SAMY10171201RBST0101493": {
            "C1": "noData",
            "C13": 21,
            "C14": 0,
            "C18": 40.5,
            "C19": 0,
            "C20": "noData",
            "C3": 20,
            "C4": 20.5,
            "T0": "0",
            "T1": "2018-05-06 13:52",
            "T2": "2018-05-07 07:08",
            "T3": "2018-05-07 07:06"
        },
        "SAMY10171201RBST0101554": {
            "C1": 13.5,
            "C13": 0,
            "C14": 0,
            "C18": 30,
            "C19": 1,
            "C20": 1,
            "C3": 32,
            "C4": 33.5,
            "T0": "0",
            "T1": "2018-04-07 05:32",
            "T2": "2018-04-07 06:07",
            "T3": "2018-04-07 06:06"
        },
        "SAMY10171201RBST0101645": {
            "C1": "noData",
            "C13": 14,
            "C14": 0,
            "C18": 25.5,
            "C19": 0.88,
            "C20": 0,
            "C3": 17.5,
            "C4": 17,
            "T0": "0",
            "T1": "2018-03-27 04:44",
            "T2": "2018-03-27 07:28",
            "T3": "2018-03-27 07:27"
        },
        "SAMY10171201RBST0101649": {
            "C1": "noData",
            "C13": 13,
            "C14": 0,
            "C18": 50,
            "C19": 0,
            "C20": "noData",
            "C3": 17.5,
            "C4": 18.5,
            "T0": "0",
            "T1": "2018-03-27 06:38",
            "T2": "2018-03-27 07:36",
            "T3": "2018-03-27 07:36"
        },
        "SAMY10171201RBST0101664": {
            "C1": 21.5,
            "C13": 21,
            "C14": 0,
            "C18": 27,
            "C19": 1,
            "C20": 0,
            "C3": 20.5,
            "C4": 20,
            "T0": "0",
            "T1": "2018-03-24 15:05",
            "T2": "2018-03-24 15:43",
            "T3": "2018-03-24 15:41"
        },
        "SAMY10171201RBST0101668": {
            "C1": "noData",
            "C13": 3,
            "C14": 0,
            "C18": 30,
            "C19": 1,
            "C20": 0,
            "C3": 39,
            "C4": 40,
            "T0": "0",
            "T1": "2018-03-18 04:49",
            "T2": "2018-03-18 06:40",
            "T3": "2018-03-18 06:40"
        },
        "XSCY10180101TEST0100029": {
            "C1": 14,
            "C10": 0,
            "C11": 0,
            "C12": 0,
            "C13": 0,
            "C14": 0,
            "C15": 0,
            "C16": 0,
            "C17": 0,
            "C18": 22,
            "C2": 0.28,
            "C3": 9,
            "C4": 0.39,
            "C5": 30,
            "C6": 0,
            "C7": 0,
            "C8": 0,
            "C9": 0,
            "T0": "1",
            "T1": "2018-09-12 14:52",
            "T2": "2018-09-12 14:39",
            "T3": "2018-09-12 17:12"
        },
        "XSCY10180101TEST0100030": {
            "C1": 14,
            "C10": 0,
            "C11": 0,
            "C12": 0,
            "C13": 0,
            "C14": 0,
            "C15": 0,
            "C16": 0,
            "C17": 0,
            "C18": 9,
            "C2": 0.82,
            "C3": 9,
            "C4": 0.31,
            "C5": 31,
            "C6": 0,
            "C7": 0,
            "C8": 0,
            "C9": 0,
            "T0": "1",
            "T1": "2018-09-12 14:52",
            "T2": "2018-09-12 14:39",
            "T3": "2018-09-12 17:12"
        }
    }
}

print(json)

def op_data(json_data):
    # 处理json数据
    #json_to_python = json.loads(json_data)
    result_data = json_data['data']
    result_key = list(result_data.keys())
    results = [[] for i in range(len(result_key))]

    for i in range(len(result_key)):
        if result_key[i]=='XSCY10180101TEST0100029' or result_key[i]=='XSCY10180101TEST0100030':
            results[i].append(result_key[i])
            a = datetime.datetime.strptime(result_data[result_key[i]]['T3'], '%Y-%m-%d %H:%M') + datetime.timedelta(
                minutes=-1)
            aa = a.strftime('%Y-%m-%d %H:%M')
            results[i].append(aa)
            results[i].append(result_data[result_key[i]]['T3'])
            results[i].append(result_data[result_key[i]]['C1'] + result_data[result_key[i]]['C2'])
            results[i].append(result_data[result_key[i]]['C3'] + result_data[result_key[i]]['C4'])
            results[i].append(result_data[result_key[i]]['C5'])
            results[i].append(result_data[result_key[i]]['C17'] + result_data[result_key[i]]['C18'])
    print(results)
    return (results)

def insert_table(results):
    con = mdb.connect('localhost', 'root', '19880511', 'shuichan');
    for i in range(len(results)):
        if results[i] !=[]:
            if results[i][0] == 'XSCY10180101TEST0100029':
                 sheb_id = 1
            else :
                 sheb_id = 2
            sheb_num = results[i][0]
            data_time = results[i][1]
            get_time = results[i][2]
            dis_o = results[i][3]
            ph = results[i][4]
            w_temp = results[i][5]
            turbidity = results[i][6]

            with con:
                cur = con.cursor()
                sql = "INSERT INTO shuichandata(sheb_id, sheb_num, data_time,get_time,dis_o,ph,w_temp,turbidity)" \
                      "VALUES('%s','%s','%s','%s','%s','%s','%s','%s')" % (
                          sheb_id, sheb_num, data_time, get_time, dis_o, ph, w_temp, turbidity)
                cur.execute(sql)

    con.close()

r=op_data(json)
insert_table(r)